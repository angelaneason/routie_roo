# Routie Roo TODO

## Calendar Badge Update (2025-12-09)
- [x] Replace current calendar badge with full calendar image (—Pngtree—calendariconwithahighlighted_22163766.png)
- [x] Display entire calendar graphic with "ON CALENDAR" header and green checkmark
- [x] Make badge larger and more prominent on route cards and detail pages
- [x] Update single-stop route map to show Routie Roo standing at destination (not holding map pin)
- [x] Change route title format to show: Name Day Date (e.g., "Alisha Gardner Friday 12/12/2025")
- [x] Increase calendar icon size even larger for better visibility (h-24 = 96px)

## Ready to Publish
- [x] Important dates display on waypoints with blank fields for missing values
- [x] Duplicate stop type legend entries fixed

(rest of file continues...)


## Scheduled Contacts Filter (2025-12-09)
- [x] Add "Show scheduled contacts" filter checkbox to contact list
- [x] Implement filter logic to show only contacts with scheduledDays or oneTimeVisits


## Scheduled Contacts Filter Bug Fix (2025-12-09)
- [x] Investigate why contacts with no visible schedule show up in scheduled filter
- [x] Fix filter logic to exclude contacts with empty/null schedule arrays
- [x] Test filter to ensure only truly scheduled contacts appear

## Route Title Simplification (2025-12-09)
- [x] Update route title generation to use format "Name - Day Date" instead of "Name - Day Route - Week of Date Day Date"
- [x] Test with Smart Auto-Routing generated routes

## Auto-Delete Incomplete Routes on Schedule Deletion (2025-12-09)
- [x] Analyze current schedule deletion logic in contacts.updateScheduledDays
- [x] Implement route cleanup to delete incomplete auto-generated routes when schedule is removed
- [x] Keep completed routes for historical records
- [x] Write tests for route cleanup functionality
- [x] Test with various route completion states

## Calendar Integration Issue (2025-12-09)
- [x] Investigate why "Add to Calendar" button is not working
- [x] Check TypeScript errors related to addToCalendar procedure
- [x] Verify OAuth flow and token handling
- [x] Test calendar event creation end-to-end
- [x] Fix any issues preventing calendar integration

## Schedule Deletion Cleanup Not Working (2025-12-09)
- [x] Investigate why deleting schedules doesn't delete incomplete routes
- [x] Check the contacts.updateScheduledDays procedure cleanup logic
- [x] Verify route deletion conditions (isAutoGenerated, completedAt, waypoint count)
- [x] Fix the cleanup logic to properly delete empty incomplete routes
- [x] Test schedule deletion with various route states

## Client Billing System Implementation (2025-12-09)
### Phase 1: Analysis & Design
- [x] Analyze RoadRunner billing model and adapt for Routie Roo
- [x] Design multi-route-holder architecture (each route holder manages their own clients)
- [x] Define client-to-route-holder relationship model
- [x] Plan billing workflow: route completion → invoice generation → payment tracking

### Phase 2: Database Schema
- [x] Create clients table with route holder foreign key
- [x] Add billing fields: mileage_rate, flat_fee_amount, hourly_rate
- [x] Add contact info fields: name, email, phone, address
- [x] Create billing_records table for completed routes
- [x] Create account_settings table for business info
- [x] Add billing status tracking: unpaid/paid with timestamps
- [x] Create database tables via SQL

### Phase 3: Backend API
- [x] Create billing.clients router with CRUD operations
- [x] Implement client.list filtered by route holder
- [x] Implement client.create with route holder association
- [x] Implement client.update and client.delete
- [x] Add billing calculations to route completion
- [x] Create invoice generation endpoint
- [x] Create payment tracking endpoints (markPaid)
- [ ] Write comprehensive tests for all endpoints

### Phase 4: Client Management UI
- [x] Create Clients page with route holder filter
- [x] Build Add/Edit Client dialog with billing rate configuration
- [x] Implement client list with search and filtering
- [x] Add client summary cards showing billing stats
- [x] Support three billing models: mileage-only, flat-fee, hourly rate
- [x] Create Billing page for viewing billing records
- [x] Create Account Settings page for business info

### Phase 5: Route Billing Integration
- [x] Auto-create billing record on route completion
- [x] Calculate charges based on billing model (mileage/flat/hourly)
- [x] Store billing data in billing_records table
- [x] Add invoice number generation
- [ ] Implement PDF invoice download
- [x] Add navigation links to sidebar
- [x] Wire up routes in App.tsx

### Phase 6: Billing Reports & Payment Tracking
- [x] Create billing report page with client filtering
- [x] Show charge breakdowns and totals
- [x] Implement "Mark as Paid" action
- [x] Add payment date tracking
- [x] Add revenue summary cards (total billed, paid, outstanding)
- [ ] Add revenue reporting by route holder
- [ ] Add date range filtering for reports

### Phase 7: Testing & Documentation
- [ ] Test complete workflow: client creation → route completion → invoice → payment
- [ ] Test with multiple route holders managing separate clients
- [ ] Test all three billing models (mileage-only, flat-fee, hourly)
- [ ] Create user guide for billing features
- [ ] Document route holder billing workflows


## Dashboard Button Navigation Issue (2025-12-10)
- [x] Investigate why Dashboard button in sidebar is not working
- [x] Check navigation path configuration in DashboardLayout
- [x] Fix Dashboard button to properly navigate to /dashboard
- [x] Test navigation from all pages


## Per-Visit Billing System Update (2025-12-10)
- [x] Analyze current billing_records schema and route completion trigger
- [x] Update billing_records to track waypointId instead of routeId
- [x] Add contactId/contactName to billing records for client tracking
- [x] Update auto-billing trigger to fire on waypoint completion (not route completion)
- [x] Calculate charges per visit based on client's billing model
- [x] Update billing UI to show itemized list of completed visits
- [x] Add per_visit billing model to schema and validation
- [x] Update database schema with new columns (waypointId, contactId, contactName, visitType, visitDate, perVisitAmount)
- [ ] Add grouping by client/route in billing records view
- [ ] Manual testing: Complete multiple waypoints and verify billing records are created
- [ ] Verify mileage/flat fee/hourly/per-visit calculations per visit


## Route Creation Error Fix (2025-12-10)
- [x] Investigate "Cannot read properties of undefined (reading 'contactId')" error
- [x] Find where contactId is accessed on undefined object in route creation
- [x] Fix the undefined reference by checking if contactId exists before creating billing record
- [x] Applied fix to skip billing for non-contact waypoints (starting points, gap stops)
- [x] Route creation now works without contactId error


## Shared Route Issues (2025-12-10)
- [x] Investigate missing address coordinates warning in shared route view
- [x] Find which waypoint has missing coordinates (WARREN Lisa)
- [x] Geocode missing addresses to get lat/lng (32.6192939, -96.8642697)
- [x] Fix map marker colors showing all black instead of custom colors (updated 11 waypoints from #050505 to #3b82f6)
- [x] Verify stopColor field is being passed to shared route view
- [x] Verify label colors are being applied in shared route view
- [x] Test shared route with custom stop types and label colors


## Label Color Issue on Route Map (2025-12-10)
- [x] Investigate why label colors aren't showing on route detail map markers
- [x] Check if waypoints have contactLabels field populated
- [x] Check if user has label colors configured in Settings
- [x] Verify marker color logic applies label colors correctly
- [x] Updated logic to use first non-gray label color when contacts have multiple labels
- [x] Test label colors on route 1860004 map


## Label Color Feature Loss Investigation (2025-12-10)
- [x] Search for all route view components (RouteDetail, SharedRoute, etc.)
- [x] Found SharedRouteExecution.tsx was using old logic (only works with exactly 1 label)
- [x] Apply label color fix to RouteDetail.tsx (authenticated view)
- [x] Apply label color fix to SharedRouteExecution.tsx (shared/public view)
- [x] Add prominent comments explaining the label color logic
- [x] Document why gray labels should be skipped
- [x] Create LABEL_COLOR_LOGIC.md documentation file


## Client Label Priority for Map Markers (2025-12-10)
- [x] Clarified: Client labels = labels with assigned colors in label_colors table
- [x] Regular labels = labels without colors (grouping labels like ♾️PT/Randy.Harms)
- [x] Simplify marker color logic: use first label with assigned color (all are client labels)
- [x] Remove gray label filtering (unnecessary since gray labels won't have colors)
- [x] Apply to RouteDetail.tsx (authenticated view) - 3 marker locations updated
- [x] Apply to SharedRouteExecution.tsx (shared/public view)
- [x] Sort labels on waypoint cards: colored labels first, then regular labels (SortableWaypointItem)
- [x] Update LABEL_COLOR_LOGIC.md documentation
- [ ] Test with contacts that have both client labels (*Abundant) and regular labels
